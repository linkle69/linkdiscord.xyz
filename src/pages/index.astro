---
import { Image } from 'astro:assets'
import { Icon } from 'astro-icon/components'
import { getSecret } from 'astro:env/server'

import Friends from '../components/Friends.astro'

const token = getSecret('DISCORD_TOKEN')
const id = '476662199872651264'

if (!token) throw new Error('No DISCORD_TOKEN secret')

let displayName = ''
let username = ''
let avatar = ''
let accentColor = ''
let selectionColor = ''
let accentColorRAW = ''

const response = await fetch(`https://discord.com/api/v10/users/${id}`, {
    headers: {
        Authorization: `Bot ${token}`
    }
})

function componentToHex(c: number) {
    const hex = c.toString(16)
    return hex.length == 1 ? '0' + hex : hex
}

function adjustColor(hexColor: string, darken = true, amount = 50) {
    const threshold = darken ? 180 : 75
    let r = parseInt(hexColor.substring(1, 3), 16)
    let g = parseInt(hexColor.substring(3, 5), 16)
    let b = parseInt(hexColor.substring(5, 7), 16)
    let brightness = (r * 299 + g * 587 + b * 114) / 1000

    if ((darken && brightness > threshold) || (!darken && brightness < threshold)) {
        r = darken ? Math.max(0, r - amount) : Math.min(255, r + amount)
        g = darken ? Math.max(0, g - amount) : Math.min(255, g + amount)
        b = darken ? Math.max(0, b - amount) : Math.min(255, b + amount)
    }

    const rc = componentToHex(r)
    const gc = componentToHex(g)
    const bc = componentToHex(b)
    return `#${rc}${gc}${bc}`
}

function hexToRGBA(hex: string, transparency = 1) {
    const r = parseInt(hex.substring(1, 3), 16)
    const g = parseInt(hex.substring(3, 5), 16)
    const b = parseInt(hex.substring(5, 7), 16)
    const a = transparency
    return `rgba(${r}, ${g}, ${b}, ${a})`
}

if (response.ok) {
    const data = await response.json()
    const animated = data.avatar.startsWith('a_')
    const extension = animated ? 'gif' : 'webp'

    avatar = `https://cdn.discordapp.com/avatars/${id}/${data.avatar}.${extension}?size=512`
    displayName = data.global_name
    username = data.username

    if (!data.accent_color) {
        accentColorRAW = '#5865F2'
        accentColor = '#c5c5c5'
        selectionColor = 'rgba(255, 255, 255, 0.5)'
    } else {
        const accentHex = `#${data.accent_color.toString(16).padStart(6, '0')}`
        const colorLighter = adjustColor(accentHex, false, 60)
        const colorDarker = adjustColor(accentHex, true, 50)

        accentColorRAW = accentHex
        accentColor = colorLighter
        selectionColor = hexToRGBA(colorDarker, 0.5)
    }
}
---

<!doctype html>
<html lang='en'>
    <head>
        <meta charset='UTF-8' />
        <meta name='viewport' content='width=device-width, initial-scale=1.0' />
        <link rel='icon' type='image/png' href='favicon-16.png' sizes='16x16' />
        <link rel='icon' type='image/png' href='favicon-32.png' sizes='32x32' />
        <link rel='icon' type='image/png' href='favicon-48.png' sizes='48x48' />
        <link rel='icon' type='image/png' href='favicon-64.png' sizes='64x64' />
        <link rel='icon' type='image/png' href='favicon-96.png' sizes='96x96' />
        <link rel='icon' type='image/png' href='favicon-192.png' sizes='192x192' />
        <title>Link</title>
        <meta name='og:title' content={displayName} />
        <meta name='og:description' content='My own silly profile website lol' />
        <meta name='description' content='My own silly profile website lol' />
        <meta name='og:image' content={avatar} />
        <meta name='og:type' content='website' />
        <meta name='og:url' content='https://linkdiscord.xyz/' />
        <meta name="og:logo" content={avatar} />
        <meta name='theme-color' content={accentColorRAW} />
        <style define:vars={{ accentColor, selectionColor }} is:global>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial,
                    sans-serif;
            }

            :root {
                --bg-color: #0f0f0f;
                --text-color: #ffffff;
                --secondary-text: #e2e2e2;
                --card-bg: rgba(255, 255, 255, 0.05);
                --button-bg: rgba(255, 255, 255, 0.1);
                --button-hover: rgba(255, 255, 255, 0.2);
            }

            *::selection {
                background-color: var(--selectionColor);
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                padding: 20px;
            }

            .profile-container {
                text-align: center;
            }

            .profile-header {
                margin-bottom: 24px;
            }

            .profile-pic {
                width: 128px;
                height: 128px;
                border-radius: 50%;
                background-color: var(--card-bg);
                border-color: var(--card-bg);
            }

            .profile-name {
                font-size: 32px;
                margin-bottom: 4px;
            }

            .profile-handle {
                color: var(--accentColor);
                font-size: 18px;
                margin-bottom: 24px;
            }

            .about-section {
                background-color: var(--card-bg);
                padding: 16px;
                border-radius: 8px;
                margin-bottom: 24px;
                text-align: left;
            }

            .about-section h2 {
                margin-bottom: 16px;
                text-align: center;
            }

            .about-section p,
            .about-section ul {
                color: var(--secondary-text);
            }

            .about-section ul {
                margin-left: 20px;
            }

            .socials {
                margin-bottom: 24px;
            }

            .social-links {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 16px;
            }

            .social-button {
                background-color: var(--button-bg);
                color: var(--text-color);
                padding: 8px 16px;
                border-radius: 20px;
                text-decoration: none;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background-color 0.2s;
            }

            .social-button:hover {
                background-color: var(--button-hover);
            }

            .friends-section {
                text-align: center;
            }

            .friends-section h2 {
                margin-bottom: 16px;
            }

            .friends-grid {
                display: flex;
                gap: 12px;
                justify-content: center;
            }

            .friend-avatar {
                width: 64px;
                height: 64px;
                border-radius: 50%;
                background-color: var(--card-bg);
            }
        </style>
    </head>

    <body>
        <div class='profile-container'>
            <div class='profile-header'>
                <Image
                    class='profile-pic'
                    src={avatar}
                    alt={displayName}
                    width={128}
                    height={128}
                    loading={'eager'}
                />
                <h1 class='profile-name'>{displayName}</h1>
                <div class='profile-handle'>@{username}</div>
            </div>

            <h2 style='margin-bottom: 16px;'>About Me</h2>

            <div class='about-section'>
                <p>Im German and I like to code and play games.</p>
                <br />
                <p>Random games that I play:</p>
                <ul>
                    <li>Honkai Star Rail</li>
                    <li>Fortnite</li>
                    <li>Minecraft</li>
                </ul>
                <br />
                <p>Honkai Star Rail UID: 700477503</p>
                <p>Minecraft Username: LinkDiscord</p>
            </div>

            <div class='socials'>
                <h2>Socials</h2>
                <div class='social-links'>
                    <a href='https://x.com/link0069' class='social-button'>
                        <Icon name='twitter' />
                        Twitter
                    </a>
                    <a href='https://github.com/link-discord' class='social-button'>
                        <Icon name='github' />
                        Github
                    </a>
                    <a href='https://steamcommunity.com/id/linkdiscord/' class='social-button'>
                        <Icon name='steam' />
                        Steam
                    </a>
                </div>
            </div>

            <Friends />
        </div>
    </body>
</html>
